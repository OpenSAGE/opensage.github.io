<!DOCTYPE html><html><head><meta charSet="utf-8"/><meta http-equiv="x-ua-compatible" content="ie=edge"/><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"/><style data-href="/component---src-templates-post-js.25a428dd87ac91a6df15.css">footer{background:#000;color:#fff;font-size:12px}.footer__content{max-width:900px;margin-left:auto;margin-right:auto;padding:8px}.header__logo{height:100px;min-height:80px;background:url(/opensage-logo.png);background-size:contain;background-position:50%;background-repeat:no-repeat}.navbar{border-bottom:2px solid #000}.navbar__items{margin:0 auto 16px;list-style:none;display:flex;flex-direction:row;justify-content:center}.nav-item{display:inline-flex}.nav-item:not(last-child){margin-right:40px}.nav-item a{color:#000;text-decoration:none}.nav-item a:hover{text-decoration:underline}.post-content img{max-width:100%}.post-content h2>a,.post-content h3>a{text-decoration:none;color:initial}.post-content li,.post-content p{text-align:justify}.post-content blockquote{border-left:4px solid #d3d3d3;padding-left:1em;margin-left:0}.post-content pre{color:#333;background:#eee;padding:1em;overflow-x:auto}.post-content pre code{line-height:1.2;font-size:.8rem}.post-content code,.post-content pre code{font-family:Source Code Pro,Menlo,Consolas,monospace}.post-content code{background:#eee;color:#333;padding:2px 4px}.post-metadata span{display:block}.post-metadata__author{font-weight:700}.post-content .video-responsive{overflow:hidden;padding-bottom:56.25%;position:relative;height:0}.post-content .video-responsive>iframe{position:absolute;top:0;left:0;width:100%;height:100%}.post-content .table-wrapper{max-width:100%;overflow-x:auto;border:1px solid #bdc1c4}.post-content table{border-collapse:collapse}.post-content table th{background-color:#f0f0f0;padding-left:1em;padding-right:1em;width:auto}.post-content table td,.post-content table th{border-bottom:1px solid #bdc1c4;border-right:1px solid #ccc;padding:.5rem;white-space:nowrap}</style><style data-href="/app.fc21a18936c09a7a9afc.css">@import url(https://fonts.googleapis.com/css?family=Noto+Serif+TC|Source+Code+Pro);
/*! normalize.css v8.0.1 | MIT License | github.com/necolas/normalize.css */html{line-height:1.15;-webkit-text-size-adjust:100%}body{margin:0}main{display:block}h1{font-size:2em;margin:.67em 0}hr{box-sizing:content-box;height:0;overflow:visible}pre{font-family:monospace,monospace;font-size:1em}a{background-color:transparent}abbr[title]{border-bottom:none;text-decoration:underline;-webkit-text-decoration:underline dotted;text-decoration:underline dotted}b,strong{font-weight:bolder}code,kbd,samp{font-family:monospace,monospace;font-size:1em}small{font-size:80%}sub,sup{font-size:75%;line-height:0;position:relative;vertical-align:baseline}sub{bottom:-.25em}sup{top:-.5em}img{border-style:none}button,input,optgroup,select,textarea{font-family:inherit;font-size:100%;line-height:1.15;margin:0}button,input{overflow:visible}button,select{text-transform:none}[type=button],[type=reset],[type=submit],button{-webkit-appearance:button}[type=button]::-moz-focus-inner,[type=reset]::-moz-focus-inner,[type=submit]::-moz-focus-inner,button::-moz-focus-inner{border-style:none;padding:0}[type=button]:-moz-focusring,[type=reset]:-moz-focusring,[type=submit]:-moz-focusring,button:-moz-focusring{outline:1px dotted ButtonText}fieldset{padding:.35em .75em .625em}legend{box-sizing:border-box;color:inherit;display:table;max-width:100%;padding:0;white-space:normal}progress{vertical-align:baseline}textarea{overflow:auto}[type=checkbox],[type=radio]{box-sizing:border-box;padding:0}[type=number]::-webkit-inner-spin-button,[type=number]::-webkit-outer-spin-button{height:auto}[type=search]{-webkit-appearance:textfield;outline-offset:-2px}[type=search]::-webkit-search-decoration{-webkit-appearance:none}::-webkit-file-upload-button{-webkit-appearance:button;font:inherit}details{display:block}summary{display:list-item}[hidden],template{display:none}*{box-sizing:border-box}body,html{margin:0;padding:0;min-height:100%;display:flex;width:100%}body{font-family:"Noto Serif TC",serif;font-size:16px;line-height:1.6}h1{margin-top:2em}h2{margin-top:1.5em;margin-bottom:.5em}#___gatsby,#___gatsby>div{display:flex;height:100%;width:100%}.page{max-width:100%}#main-content,.page{display:flex;flex-direction:column;flex-grow:1;width:100%}#main-content{flex-shrink:0;padding-left:2em;padding-right:2em;margin-left:auto;margin-right:auto;margin-bottom:40px;max-width:700px}.row{display:flex;flex-direction:row;flex-shrink:0}.row+.row{margin-top:16px}.width-50{max-width:50%;flex-shrink:0}.responsive-image{display:flex;flex-shrink:1;max-width:100%}.responsive-image+.responsive-image,.responsive-image-container+.responsive-image-container{margin-left:16px}@media screen and (max-width:450px){.row{flex-direction:column}.responsive-image,.responsive-image+.responsive-image,.responsive-image-container+.responsive-image-container{margin-top:16px;margin-left:0}}code[class*=language-],pre[class*=language-]{color:#000;background:none;text-shadow:0 1px #fff;font-family:Consolas,Monaco,Andale Mono,Ubuntu Mono,monospace;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-ms-hyphens:none;hyphens:none}code[class*=language-]::selection,code[class*=language-] ::selection,pre[class*=language-]::selection,pre[class*=language-] ::selection{text-shadow:none;background:#b3d4fc}@media print{code[class*=language-],pre[class*=language-]{text-shadow:none}}pre[class*=language-]{padding:1em;margin:.5em 0;overflow:auto}:not(pre)>code[class*=language-],pre[class*=language-]{background:#f5f2f0}:not(pre)>code[class*=language-]{padding:.1em;border-radius:.3em;white-space:normal}.token.cdata,.token.comment,.token.doctype,.token.prolog{color:#708090}.token.punctuation{color:#999}.namespace{opacity:.7}.token.boolean,.token.constant,.token.deleted,.token.number,.token.property,.token.symbol,.token.tag{color:#905}.token.attr-name,.token.builtin,.token.char,.token.inserted,.token.selector,.token.string{color:#690}.language-css .token.string,.style .token.string,.token.entity,.token.operator,.token.url{color:#9a6e3a;background:hsla(0,0%,100%,.5)}.token.atrule,.token.attr-value,.token.keyword{color:#07a}.token.class-name,.token.function{color:#dd4a68}.token.important,.token.regex,.token.variable{color:#e90}.token.bold,.token.important{font-weight:700}.token.italic{font-style:italic}.token.entity{cursor:help}</style><meta name="generator" content="Gatsby 2.0.73"/><title data-react-helmet="true">Parsing Command &amp; Conquer: Generals replay files - OpenSAGE</title><meta data-react-helmet="true" name="viewport" content="width=device-width, initial-scale=1"/><link as="script" rel="preload" href="/webpack-runtime-293e875d3292be04e83b.js"/><link as="script" rel="preload" href="/app-655b54fb054b7e85ea3d.js"/><link as="script" rel="preload" href="/0-f45a33594b6668cdd6f8.js"/><link as="script" rel="preload" href="/1-99665077469193db6513.js"/><link as="script" rel="preload" href="/component---src-templates-post-js-40108c553aa84ce37c7c.js"/><link as="fetch" rel="preload" href="/static/d/602/path---blog-parsing-command-and-conquer-generals-replay-files-5-f-3-662-RlrRYWsbhCuTC90tZQ8xAClhz0.json" crossOrigin="use-credentials"/></head><body><div id="___gatsby"><div style="outline:none" tabindex="-1" role="group"><div class="page"><header><a href="/"><div class="header__logo"></div></a><nav class="navbar"><ol class="navbar__items"><li class="nav-item"><a href="/">About</a></li><li class="nav-item"><a href="/blog">Blog</a></li><li class="nav-item"><a href="https://github.com/OpenSAGE/OpenSAGE">GitHub</a></li><li class="nav-item"><a href="https://discord.gg/G2FhZUT">Discord</a></li></ol></nav></header><div id="main-content"><h1>Parsing Command &amp; Conquer: Generals replay files</h1><div class="post-metadata"><span class="post-metadata__author">Tim Jones</span><span class="post-metadata__date">06 March 2018</span></div><div class="post-content"><p><em><a href="http://timjones.io/blog/archive/2018/03/06/parsing-command-and-conquer-generals-replay-files">This post</a> was originally published on Tim's blog.</em></p>
<p><strong>TL/DR: In this post we'll examine C&#x26;C Generals replay (.rep) files in detail, figure out how they work, and then look at a very early implementation of a replay viewer that I've added to <a href="https://github.com/OpenSAGE/OpenSAGE">OpenSAGE</a>.</strong></p>
<p>Have you ever saved a replay from [insert your favourite video game here], and wondered exactly what the replay file contains? I don't know how many people will answer "yes" to that question, but I'm one of them. For efficiency and IP-protection reasons, replay files are usually stored in a binary format, so if you open one of them in Notepad, all you'll see are a bunch of garbled characters. It's often a long road from there, to fully understanding and being able to parse one of these files.</p>
<p>One of the features I hope to support in <a href="https://github.com/OpenSAGE/OpenSAGE">OpenSAGE</a> is being able to use replay files from the original Command &#x26; Conquer: Generals and Zero Hour games. Since no official description of Generals' replay file format has been published, I have to do it the hard way, and figure out the file format... but fortunately, I'm not the first to want to do this.</p>
<p>I should note here that replay files vary wildly between games, so what applies to one specific RTS game won't apply directly to other games, but the general principles should be similar, at least across RTS games.</p>
<p>Before we get into the details, let's start with the fun part: creating a replay file in the first place.</p>
<h2>Creating a replay file</h2>
<p>Let's load C&#x26;C Generals, and play a quick skirmish game. For the purposes of this blog post, I want to keep the replay file <em>really</em> simple, so all I'll do is start a single-player skirmish game, build one building, and exit. Here's what that looks like:</p>
<div class="video-responsive">
    <iframe width="560" height="315" src="https://www.youtube.com/embed/Nv0NdiYz1fA" frameborder="0" gesture="media" allow="encrypted-media" allowfullscreen></iframe>
</div>
<p>Here's the replay file that Generals saved for that game:</p>
<ul>
<li><a href="/assets/parsing-command-and-conquer-generals-replay-files/simple-generals-replay.rep">simple-generals-replay.rep</a></li>
</ul>
<h2>First look</h2>
<p>If we open that replay file in VSCode using the excellent <a href="https://marketplace.visualstudio.com/items?itemName=slevesque.vscode-hexdump">hexdump</a> extension, we'll see this:</p>
<p><a
    class="gatsby-resp-image-link"
    href="/static/fdce9e60e692481de46a0ac65233caca/55fe9/generals-replay-hex.png"
    style="display: block"
    target="_blank"
    rel="noopener"
  >
    <span
    class="gatsby-resp-image-wrapper"
    style="position: relative; display: block;  max-width: 600px; margin-left: auto; margin-right: auto;"
  >
    <span
      class="gatsby-resp-image-background-image"
      style="padding-bottom: 99.41916747337851%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAUCAYAAACNiR0NAAAACXBIWXMAABYlAAAWJQFJUiTwAAADA0lEQVQ4y1VU2XLbMAzMj1QHKcp2YlsndfvoxOkx7f//zhYLSk7zgAEFD9fYxRIveZ6jrmtUVYWiLFFWDaqmRVm3yNwO1u0ltrzXWrblzMFah4yRhXiJ41gKFqfhHYfuHUUzoO5mjXPdo/RbnlD3y7N2qjyM3MsOFjY3SG2KJE3wEkXfEAmoq66w5YzifEbb1Oh8i7Zt0Hdes5cY+g6VsOB3LYyMNUhsjDRLNBITEzBCkiTY+Xe45jtO5wJ932MYBjRNo+eu6zRYa9t2/a2FzQKgcakCxskTMMVh/ovd8FsueFwuFw1evN5uGMcR0zThfr9jkvONtWEUHW0AzFOhLaA2WQHTFPvhF/LuA5UMiJcJSKB5njVvoN57TFJjxxsgu7O7NFCO4wDoqguycsHxeEQpOvEip0+KVVWqC1g/n09yriWfkZoERoBI2b2a0CEBUwHc+Qdy0fHteFLtWgle8l0A3v6E4Mz8NkaA3iz2hcOhdAqstjHG4DAFDeu6Ue1I0ftOafbrQJSydEwZ+q6Hyy0OtcNrk+NQOaWtgGlqRMOfqmFZVtohNSJNTpk24VT71Tah00qn7N4M8iP9aFYNo03DBVkxCeWjUiUl6qkvqCgkgo6n0+mZaWTjEmR7o3TXoUiHQpk+zOob6qZRWqNQ7KQ70hxXCUibHS/LotmKsdXUNkQk81g1FC2mP3D+QwBm3K5X9Ry1YqbvluWimXZ6PB4KSu0jdUms3amxnxr2P/SlcBD/++4q4MwE5Jl1ZuqYCmX6ME4iBV47/NTQnkfRr3h6brMKh0Tv0ZO15IZZrKSAJnT3hTI7pA9dcxcNW53wvL6GeQ56Maill6fJ3whIHyqgUNaXEoz9qWEutL34a1zf60WokR41vYmWPBOMv1EGl2dIHbuUxSCg8bNDEXcvHuSUW6G4acgOeZGZ1MOUBwXuh14pE4ivhdPmXvjiQ2pIrQgQdKueBud3I3uSnmSNmVMNyyUsCIJ/atg9dMpcX9vTo25h24Rnt3W7ZS5Yk4c9uC3YfzsJaAZKgnc6AAAAAElFTkSuQmCC'); background-size: cover; display: block;"
    ></span>
    <img
        class="gatsby-resp-image-image"
        style="width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;box-shadow:inset 0px 0px 0px 400px white;"
        alt="Hex view of C&C Generals replay file"
        title=""
        src="/static/fdce9e60e692481de46a0ac65233caca/7a630/generals-replay-hex.png"
        srcset="/static/fdce9e60e692481de46a0ac65233caca/46d37/generals-replay-hex.png 150w,
/static/fdce9e60e692481de46a0ac65233caca/c218a/generals-replay-hex.png 300w,
/static/fdce9e60e692481de46a0ac65233caca/7a630/generals-replay-hex.png 600w,
/static/fdce9e60e692481de46a0ac65233caca/91b84/generals-replay-hex.png 900w,
/static/fdce9e60e692481de46a0ac65233caca/55fe9/generals-replay-hex.png 1033w"
        sizes="(max-width: 600px) 100vw, 600px"
      />
  </span>
  </a></p>
<p>You can immediately see some human-readable text there. That's always nice to see, when you're parsing an unknown binary format.</p>
<p>It was at this point, when I first looked at Generals' replay files, that I wondered whether anybody else had figured out the file format before. So I Googled and found <a href="https://github.com/louisdx/cnc-replayreaders">the cnc-replayreaders repo on GitHub</a>, which contains at least <em>some</em> work on parsing replay files for many SAGE games, including, happily, C&#x26;C Generals. Without this information, proceeding further would have been much harder. <a href="https://github.com/louisdx/cnc-replayreaders/blob/master/ccgzhreader.cpp">Here's the C++ code for a prototype version of a Generals replay parser</a>. There's even a <a href="https://github.com/louisdx/cnc-replayreaders/blob/master/eareplay.html">document with the beginnings of a spec for these replay files</a>. This is great stuff! Many thanks to <a href="https://github.com/louisdx">louisdx</a>, who I believe also goes by the name <a href="https://www.gamereplays.org/community/index.php?s=82acbb27d5c639b8dc4210422352778b&#x26;showuser=122871">R Schneider on gamereplays.org</a>. I'll duplicate the Generals part of it here:</p>
<blockquote>
<h3>Generals, Zero Hour, Battle for Middle Earth, Rise of the Witch King</h3>
<p>The replay format of the games <em>Generals</em>, <em>Zero Hour</em>, <em>Battle for Middle Earth</em>, <em>Battle for Middle Earth 2</em>, and its expansion <em>Rise of the Witch King</em> is considerably simpler than that of the later games. Most notably, the chunks do not have length information, so one must know their sizes by other means. Also, there is no footer, just a final chunk.</p>
<h4>Header</h4>
<p>The size <code class="language-text">u1</code> is 12 for <em>Generals</em> and <em>Zero Hour</em>, and 21 in the BfME games; <code class="language-text">u2</code> is 8 in CCG/ZH and 13 in the BfME games; <code class="language-text">u3</code> is 4 except in BfME2, where it is 6.</p>
<div class="gatsby-highlight" data-language="c"><pre class="language-c"><code class="language-c"><span class="token keyword">char</span>             str_magic<span class="token punctuation">[</span><span class="token number">6</span><span class="token operator">/</span><span class="token number">8</span><span class="token punctuation">]</span><span class="token punctuation">;</span>     <span class="token comment">// == "GENREP", "BFMEREPL" or "BFME2RPL"</span>
uint32_t         timestamp_begin<span class="token punctuation">;</span>
uint32_t         timestamp_end<span class="token punctuation">;</span>
byte             unknown1<span class="token punctuation">[</span>u1<span class="token punctuation">]</span><span class="token punctuation">;</span>
tb_str           str_filename<span class="token punctuation">;</span>
tb_ch            date_time<span class="token punctuation">[</span><span class="token number">8</span><span class="token punctuation">]</span><span class="token punctuation">;</span>       <span class="token comment">// as in TW/KW</span>
tb_str           str_version<span class="token punctuation">;</span>
tb_str           str_build_date<span class="token punctuation">;</span>
uint16_t         version_minor<span class="token punctuation">;</span>
uint16_t         version_major<span class="token punctuation">;</span>
byte             magic_hash<span class="token punctuation">[</span>u2<span class="token punctuation">]</span>
<span class="token keyword">char</span>             header<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>           <span class="token comment">// null-terminated!</span>
uint16_t         unknown2<span class="token punctuation">;</span>
uint32_t         unkonwn3<span class="token punctuation">[</span>u3<span class="token punctuation">]</span><span class="token punctuation">;</span></code></pre></div>
<p><strong>Remarks.</strong> The two timestamps appear to indicate the real-world start and end time of the game. The <code class="language-text">header</code> is of the same format as the later games.</p>
<h4>The replay body</h4>
<p>The replay body consists of a sequence of <em>chunks</em>. Each chunk is of the following form:</p>
<div class="gatsby-highlight" data-language="c"><pre class="language-c"><code class="language-c">uint32_t         time_code<span class="token punctuation">;</span>
uint32_t         chunk_code<span class="token punctuation">;</span>
uint32_t         number<span class="token punctuation">;</span>         <span class="token comment">// Player number?</span>
byte             number_of_commands<span class="token punctuation">;</span>
<span class="token keyword">struct</span> <span class="token punctuation">{</span> byte cmd<span class="token punctuation">,</span> byte nargs <span class="token punctuation">}</span> signature<span class="token punctuation">[</span>number_of_commands<span class="token punctuation">]</span><span class="token punctuation">;</span>
byte             arguments<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>    <span class="token comment">// variable!</span></code></pre></div>
<p>In the simplest case, <code class="language-text">number_of_commands</code> is zero and <code class="language-text">signature</code> and <code class="language-text">arguments</code> are empty. Otherwise, there are <code class="language-text">number_of_commands</code> many pairs of bytes {<code class="language-text">cmd</code>,<code class="language-text">nargs</code>}, where <code class="language-text">cmd</code> refers to one of about ten commands and <code class="language-text">nargs</code> is the number of arguments. The size of an argument depends on the command type. Finally, <code class="language-text">arguments</code>  consists of all the arguments of all the commands, simply one after the other.
The meaning of the chunk codes is unknown in general. Only a handful of values seem to occur, all in the range 0x300 - 0x500, and 0x1B, 0x1D. Many codes only ever seem to appear with a fixed, specific signature of commands.
These are the known commands and their argument sizes.</p>
<div class="table-wrapper">
<table>
<thead>
<tr>
<th>command</th>
<th>argument size (bytes)</th>
<th>Description/Notes</th>
</tr>
</thead>
<tbody>
<tr>
<td>0x00</td>
<td>4</td>
<td>?</td>
</tr>
<tr>
<td>0x01</td>
<td>4</td>
<td>?</td>
</tr>
<tr>
<td>0x02</td>
<td>1</td>
<td>?</td>
</tr>
<tr>
<td>0x03</td>
<td>4</td>
<td>?</td>
</tr>
<tr>
<td>0x04</td>
<td>4</td>
<td>?</td>
</tr>
<tr>
<td>0x06</td>
<td>12</td>
<td>3 uint32_t's? 1 long double?</td>
</tr>
<tr>
<td>0x07</td>
<td>12</td>
<td>3 uint32_t's? 1 long double?</td>
</tr>
<tr>
<td>0x08</td>
<td>16</td>
<td>4 uint32_t's?</td>
</tr>
<tr>
<td>0x09</td>
<td>4/16</td>
<td>4 bytes in BFME2, 16 otherwise</td>
</tr>
<tr>
<td>0x0A</td>
<td>4</td>
<td>4 uint32_t's?</td>
</tr>
</tbody>
</table>
</div>
There is no footer. The final chunk has `number_of_commands` set to zero, and it appears to have command code 0x1B or 0x1D.
</blockquote>
<h2>Parsing the header</h2>
<p>Armed with that information, let's get started with parsing the header. I'll use C# here, because that's what we're using in the <a href="https://github.com/OpenSAGE/OpenSAGE/tree/master/src/OpenSage.Game/Data/Rep">OpenSAGE</a> project, but really any language that gives you the ability to read from a byte stream will work.</p>
<p>Before we can parse anything, we need to open a <code class="language-text">BinaryReader</code> for the replay file:</p>
<div class="gatsby-highlight" data-language="csharp"><pre class="language-csharp"><code class="language-csharp"><span class="token keyword">using</span> <span class="token punctuation">(</span><span class="token keyword">var</span> stream <span class="token operator">=</span> File<span class="token punctuation">.</span><span class="token function">OpenRead</span><span class="token punctuation">(</span><span class="token string">"simple-generals-replay.rep"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token keyword">using</span> <span class="token punctuation">(</span><span class="token keyword">var</span> reader <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">BinaryReader</span><span class="token punctuation">(</span>stream<span class="token punctuation">,</span> Encoding<span class="token punctuation">.</span>Unicode<span class="token punctuation">,</span> <span class="token keyword">true</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token comment">// TODO: Parse header</span>
    <span class="token comment">// TODO: Parse body</span>
<span class="token punctuation">}</span></code></pre></div>
<p>Now we can parse the header, based on the description above. I've commented most lines with the actual values from our sample replay file.</p>
<div class="gatsby-highlight" data-language="csharp"><pre class="language-csharp"><code class="language-csharp"><span class="token keyword">string</span> magic<span class="token punctuation">;</span>
<span class="token keyword">using</span> <span class="token punctuation">(</span><span class="token keyword">var</span> asciiReader <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">BinaryReader</span><span class="token punctuation">(</span>stream<span class="token punctuation">,</span> Encoding<span class="token punctuation">.</span>ASCII<span class="token punctuation">,</span> <span class="token keyword">true</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    magic <span class="token operator">=</span> asciiReader<span class="token punctuation">.</span><span class="token function">ReadFixedLengthString</span><span class="token punctuation">(</span><span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// "GENREP"</span>
<span class="token punctuation">}</span>

<span class="token keyword">var</span> origin <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DateTime</span><span class="token punctuation">(</span><span class="token number">1970</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> DateTimeKind<span class="token punctuation">.</span>Utc<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">DateTime</span> <span class="token function">readTimestamp</span><span class="token punctuation">(</span><span class="token class-name">BinaryReader</span> reader<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> origin<span class="token punctuation">.</span><span class="token function">AddSeconds</span><span class="token punctuation">(</span>reader<span class="token punctuation">.</span><span class="token function">ReadUInt32</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">var</span> timestampBegin <span class="token operator">=</span> <span class="token function">ReadTimestamp</span><span class="token punctuation">(</span>reader<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// "2018-03-05 1:28:17 UTC"</span>
<span class="token keyword">var</span> timestampEnd <span class="token operator">=</span> <span class="token function">ReadTimestamp</span><span class="token punctuation">(</span>reader<span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token comment">// "2018-03-05 1:28:42 UTC"</span>

<span class="token keyword">var</span> numTimecodes <span class="token operator">=</span> reader<span class="token punctuation">.</span><span class="token function">ReadUInt16</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// "577"</span>

<span class="token keyword">var</span> unknown1 <span class="token operator">=</span> reader<span class="token punctuation">.</span><span class="token function">ReadBytes</span><span class="token punctuation">(</span><span class="token number">12</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// Sometimes all zeros, and sometimes not</span>

<span class="token keyword">var</span> filename <span class="token operator">=</span> reader<span class="token punctuation">.</span><span class="token function">ReadNullTerminatedString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// "Last Replay"</span>

<span class="token keyword">var</span> dateTime <span class="token operator">=</span> ReplayTimestamp<span class="token punctuation">.</span><span class="token function">Parse</span><span class="token punctuation">(</span>reader<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// "2018-03-05 21:28:17.402 Monday"</span>

<span class="token keyword">var</span> version <span class="token operator">=</span> reader<span class="token punctuation">.</span><span class="token function">ReadNullTerminatedString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// "Version 1.7"</span>
<span class="token keyword">var</span> buildDate <span class="token operator">=</span> reader<span class="token punctuation">.</span><span class="token function">ReadNullTerminatedString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// "Sep  6 2012 09:43:29"</span>

<span class="token keyword">var</span> versionMinor <span class="token operator">=</span> reader<span class="token punctuation">.</span><span class="token function">ReadUInt16</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 7</span>
<span class="token keyword">var</span> versionMajor <span class="token operator">=</span> reader<span class="token punctuation">.</span><span class="token function">ReadUInt16</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 1</span>

<span class="token keyword">var</span> magicHash <span class="token operator">=</span> reader<span class="token punctuation">.</span><span class="token function">ReadBytes</span><span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 236, 122, 38, 27, 251, 102, 39, 119</span>

<span class="token keyword">var</span> metadata <span class="token operator">=</span> reader<span class="token punctuation">.</span><span class="token function">ReadNullTerminatedAsciiString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// "M=07maps/desert fury;MC=83506418;MS=214497;SD=625705968;C=100;S=HDESKTOP-9V9469L,0,0,TT,-1,2,-1,-1,1:CH,-1,-1,-1,-1:X:X:X:X:X:X:;"</span>

<span class="token keyword">var</span> unknown2 <span class="token operator">=</span> reader<span class="token punctuation">.</span><span class="token function">ReadUInt16</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// "48"</span>

<span class="token keyword">var</span> unknown3 <span class="token operator">=</span> reader<span class="token punctuation">.</span><span class="token function">ReadUInt32</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// "1"</span>
<span class="token keyword">var</span> unknown4 <span class="token operator">=</span> reader<span class="token punctuation">.</span><span class="token function">ReadUInt32</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// "2"</span>
<span class="token keyword">var</span> unknown5 <span class="token operator">=</span> reader<span class="token punctuation">.</span><span class="token function">ReadUInt32</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// "0"</span>

<span class="token keyword">var</span> gameSpeed <span class="token operator">=</span> reader<span class="token punctuation">.</span><span class="token function">ReadUInt32</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// "30"</span></code></pre></div>
<p>So, the header spec in the <a href="https://github.com/louisdx/cnc-replayreaders/blob/master/eareplay.html">cnc-replayreaders project</a> looks pretty accurate. I've worked out that one of the unknowns is the game speed. I don't know about the others, but by comparing enough replays with known game states, it should be possible to work them out.</p>
<p>This already gives us quite a lot of interesting data, such as the map, player details, start and end times, and even the date that the version of Generals that I'm using was compiled (September 6th 2012, apparently).</p>
<p>This is all very well, but what I'm really interested in is the actual replay data.</p>
<h2>Parsing the body</h2>
<p>There are many ways game replay data can be saved. If there aren't too many "things" in the world to keep track of, you could store the entire state of the world at every timestep. For RTS games with potentially hundreds or thousands of units, this wouldn't scale - and so these games usually only save player inputs, and use those inputs to recreate the entire simulation. (This is also why you often can't rewind replays; you'd have to start from the beginning again, and simulate every frame up to the one you're interested in, in order to get the correct state for that frame.)</p>
<p>Knowing that, what I'm expecting to see in the body of the replay file is a sequence of commands (or "orders", as I've chosen to call them), roughly corresponding to the actions I performed in the game. For example, "select unit" and "create power plant". Each of those orders would have arguments relevant to the order type. For example, "select unit" would have some sort of identifier to store which unit was selected.</p>
<p>There may be (and in fact, are) some orders that weren't triggered by me, such as an "end game" order - anything that the game can't recreate by itself needs to be saved in the replay file.</p>
<p>Fortunately for us, the cnc-replayreaders spec appears to match this concept, so we're on the right track. It looks like a "chunk" is probably a single order, and every order has 0 or more arguments.</p>
<p>The body of a replay file is composed of <code class="language-text">n</code> chunks. There's no way to know how many chunks there are from the header - after reading the header, you just have to keep reading chunks until you get to the end of the file. Like this:</p>
<div class="gatsby-highlight" data-language="csharp"><pre class="language-csharp"><code class="language-csharp"><span class="token keyword">while</span> <span class="token punctuation">(</span>reader<span class="token punctuation">.</span>BaseStream<span class="token punctuation">.</span>Position <span class="token operator">&lt;</span> reader<span class="token punctuation">.</span>BaseStream<span class="token punctuation">.</span>Length<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token comment">// TODO: Parse chunk</span>
<span class="token punctuation">}</span></code></pre></div>
<p>Let's look at the basic structure of a chunk. Then we can impose that structure onto our sample replay file and see what we get.</p>
<p>Let's use the description quoted above, and convert it into the code to parse a chunk header:</p>
<div class="gatsby-highlight" data-language="csharp"><pre class="language-csharp"><code class="language-csharp"><span class="token keyword">var</span> timecode <span class="token operator">=</span> reader<span class="token punctuation">.</span><span class="token function">ReadUInt32</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 0-based timecode</span>
<span class="token keyword">var</span> orderType <span class="token operator">=</span> reader<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">ReadUInt32AsEnum</span><span class="token punctuation">&lt;</span><span class="token class-name">OrderType</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// See below</span>
<span class="token keyword">var</span> number <span class="token operator">=</span> reader<span class="token punctuation">.</span><span class="token function">ReadUInt32</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 0-based index of this chunk</span>

<span class="token keyword">var</span> numUniqueArgumentTypes <span class="token operator">=</span> reader<span class="token punctuation">.</span><span class="token function">ReadByte</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// Number of unique argument types</span>

<span class="token comment">// Pairs of {argument type, count}.</span>
<span class="token keyword">var</span> argumentCounts <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token punctuation">(</span><span class="token class-name">OrderArgumentType</span> argumentType<span class="token punctuation">,</span> <span class="token keyword">byte</span> count<span class="token punctuation">)</span><span class="token punctuation">[</span>numUniqueArgumentTypes<span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">var</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> numUniqueArgumentTypes<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token comment">// Read the number of arguments for this argument type.</span>
    argumentCounts<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">(</span>reader<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">ReadByteAsEnum</span><span class="token punctuation">&lt;</span><span class="token class-name">OrderArgumentType</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> reader<span class="token punctuation">.</span><span class="token function">ReadByte</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// TODO: Read argument data</span></code></pre></div>
<p>We don't know what <code class="language-text">orderType</code> means yet; we'll have to look at the chunks, once we've parsed them, and make some guesses. We'll do that below.</p>
<p><code class="language-text">argumentCounts</code> stores the number of arguments <em>for each argument type</em>. So there might be 2 integer arguments, 1 boolean argument, and 1 float argument, for example. We can calculate the total number of arguments by summing the counts of each argument type.</p>
<p>Our first order of business is working out how many bytes each argument value uses, because without knowing that, we don't know where the next chunk starts.</p>
<p>There's nothing in the chunk header that directly tells us how big the argument data array is. We need to derive it from the number and type of arguments. I worked out the argument types from looking at a few replay files in a hex viewer and making some educated guesses. This fills in the gaps in the table of commands that I quoted above. Here's what I've found so far, although I'm sure there are more:</p>
<div class="gatsby-highlight" data-language="csharp"><pre class="language-csharp"><code class="language-csharp"><span class="token keyword">enum</span> OrderArgumentType <span class="token punctuation">:</span> <span class="token keyword">byte</span>
<span class="token punctuation">{</span>
    Integer <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span>       <span class="token comment">// int32 (4 bytes)</span>
    Float <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">,</span>         <span class="token comment">// float32 (4 bytes)</span>
    Boolean <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">,</span>       <span class="token comment">// bool (1 byte)</span>
    ObjectId <span class="token operator">=</span> <span class="token number">3</span><span class="token punctuation">,</span>      <span class="token comment">// uint32 (4 bytes)</span>
    Position <span class="token operator">=</span> <span class="token number">6</span><span class="token punctuation">,</span>      <span class="token comment">// float32 * 3 (12 bytes)</span>
    ScreenPosition <span class="token operator">=</span> <span class="token number">7</span> <span class="token comment">// int32 * 2 (8 bytes)</span>
<span class="token punctuation">}</span></code></pre></div>
<p>Now we can write the code to parse order arguments. Note that, to keep things simple, I'm not doing anything with the parsed variables, but <a href="https://github.com/OpenSAGE/OpenSAGE/blob/6887852b18b51c08359b7cc03634a4e02218741f/src/OpenSage.Game/Data/Rep/ReplayChunk.cs#L37">in the real code</a> I do.</p>
<div class="gatsby-highlight" data-language="csharp"><pre class="language-csharp"><code class="language-csharp"><span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">var</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> numUniqueArgumentTypes<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">ref</span> <span class="token keyword">var</span> argumentCount <span class="token operator">=</span> <span class="token keyword">ref</span> argumentCounts<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">var</span> argumentType <span class="token operator">=</span> argumentCount<span class="token punctuation">.</span>argumentType<span class="token punctuation">;</span>

    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">var</span> j <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> j <span class="token operator">&lt;</span> argumentCount<span class="token punctuation">.</span>count<span class="token punctuation">;</span> j<span class="token operator">++</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">switch</span> <span class="token punctuation">(</span>argumentType<span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            <span class="token keyword">case</span> OrderArgumentType<span class="token punctuation">.</span>Integer<span class="token punctuation">:</span>
                <span class="token keyword">var</span> i <span class="token operator">=</span> reader<span class="token punctuation">.</span><span class="token function">ReadInt32</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>

            <span class="token keyword">case</span> OrderArgumentType<span class="token punctuation">.</span>Float<span class="token punctuation">:</span>
                <span class="token keyword">var</span> f <span class="token operator">=</span> reader<span class="token punctuation">.</span><span class="token function">ReadSingle</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>

            <span class="token keyword">case</span> OrderArgumentType<span class="token punctuation">.</span>Boolean<span class="token punctuation">:</span>
                <span class="token keyword">var</span> b <span class="token operator">=</span> reader<span class="token punctuation">.</span><span class="token function">ReadBooleanChecked</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>

            <span class="token keyword">case</span> OrderArgumentType<span class="token punctuation">.</span>ObjectId<span class="token punctuation">:</span>
                <span class="token keyword">var</span> oi <span class="token operator">=</span> reader<span class="token punctuation">.</span><span class="token function">ReadUInt32</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>

            <span class="token keyword">case</span> OrderArgumentType<span class="token punctuation">.</span>Position<span class="token punctuation">:</span>
                <span class="token keyword">var</span> p <span class="token operator">=</span> reader<span class="token punctuation">.</span><span class="token function">ReadVector3</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>

            <span class="token keyword">case</span> OrderArgumentType<span class="token punctuation">.</span>ScreenPosition<span class="token punctuation">:</span>
                <span class="token keyword">var</span> sp <span class="token operator">=</span> reader<span class="token punctuation">.</span><span class="token function">ReadPoint2D</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>

            <span class="token keyword">default</span><span class="token punctuation">:</span>
                <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">InvalidOperationException</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre></div>
<p>Armed with all that code, we can finally parse our sample replay file. Let's do that, and write out all the replay chunks from our sample replay file. I've trimmed it down, because the replay file contains 733 lines - i.e. 733 orders - most of which are duplicate <code class="language-text">1092</code> orders. I've marked the trimmed lines with "...".</p>
<div class="table-wrapper">
<table>
<thead>
<tr>
<th>Timecode</th>
<th>OrderType</th>
<th>Number</th>
<th>Arg 1</th>
<th>Arg 2</th>
<th>Arg 3</th>
<th>Arg 4</th>
<th>Arg 5</th>
<th>Arg 6</th>
</tr>
</thead>
<tbody>
<tr>
<td>0</td>
<td>1092</td>
<td>0</td>
<td>Position:&#x3C;0, 0, 0></td>
<td>Float:0</td>
<td>Float:0</td>
<td>Float:1.490186</td>
<td>Integer:2</td>
<td>ScreenPosition:&#x3C;0, 0></td>
</tr>
<tr>
<td>1</td>
<td>1095</td>
<td>2</td>
<td>Integer:431591478</td>
<td>Boolean:False</td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>1</td>
<td>1092</td>
<td>2</td>
<td>Position:&#x3C;443.9366, 1997.808, 0></td>
<td>Float:0</td>
<td>Float:0</td>
<td>Float:1.278409</td>
<td>Integer:2</td>
<td>ScreenPosition:&#x3C;174, 521></td>
</tr>
<tr>
<td>2</td>
<td>1092</td>
<td>2</td>
<td>Position:&#x3C;443.9366, 1997.808, 0></td>
<td>Float:0</td>
<td>Float:0</td>
<td>Float:1.278409</td>
<td>Integer:16</td>
<td>ScreenPosition:&#x3C;174, 521></td>
</tr>
<tr>
<td>...</td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>96</td>
<td>1092</td>
<td>2</td>
<td>Position:&#x3C;443.9366, 1997.808, 0></td>
<td>Float:0</td>
<td>Float:0</td>
<td>Float:1.278409</td>
<td>Integer:13</td>
<td>ScreenPosition:&#x3C;470, 322></td>
</tr>
<tr>
<td>97</td>
<td>1092</td>
<td>2</td>
<td>Position:&#x3C;443.9366, 1997.808, 0></td>
<td>Float:0</td>
<td>Float:0</td>
<td>Float:1.278409</td>
<td>Integer:13</td>
<td>ScreenPosition:&#x3C;470, 324></td>
</tr>
<tr>
<td>98</td>
<td>1003</td>
<td>2</td>
<td>Boolean:True</td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>98</td>
<td>1001</td>
<td>2</td>
<td>Boolean:True</td>
<td>ObjectId:469</td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>98</td>
<td>1092</td>
<td>2</td>
<td>Position:&#x3C;443.9366, 1997.808, 0></td>
<td>Float:0</td>
<td>Float:0</td>
<td>Float:1.278409</td>
<td>Integer:2</td>
<td>ScreenPosition:&#x3C;470, 324></td>
</tr>
<tr>
<td>99</td>
<td>1092</td>
<td>2</td>
<td>Position:&#x3C;443.9366, 1997.808, 0></td>
<td>Float:0</td>
<td>Float:0</td>
<td>Float:1.278409</td>
<td>Integer:13</td>
<td>ScreenPosition:&#x3C;470, 324></td>
</tr>
<tr>
<td>100</td>
<td>1092</td>
<td>2</td>
<td>Position:&#x3C;443.9366, 1997.808, 0></td>
<td>Float:0</td>
<td>Float:0</td>
<td>Float:1.278409</td>
<td>Integer:13</td>
<td>ScreenPosition:&#x3C;470, 324></td>
</tr>
<tr>
<td>101</td>
<td>1095</td>
<td>2</td>
<td>Integer:1160876625</td>
<td>Boolean:False</td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>101</td>
<td>1092</td>
<td>2</td>
<td>Position:&#x3C;443.9366, 1997.808, 0></td>
<td>Float:0</td>
<td>Float:0</td>
<td>Float:1.278409</td>
<td>Integer:13</td>
<td>ScreenPosition:&#x3C;470, 324></td>
</tr>
<tr>
<td>102</td>
<td>1092</td>
<td>2</td>
<td>Position:&#x3C;443.9366, 1997.808, 0></td>
<td>Float:0</td>
<td>Float:0</td>
<td>Float:1.278409</td>
<td>Integer:13</td>
<td>ScreenPosition:&#x3C;470, 324></td>
</tr>
<tr>
<td>...</td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>199</td>
<td>1092</td>
<td>2</td>
<td>Position:&#x3C;443.9366, 1997.808, 0></td>
<td>Float:0</td>
<td>Float:0</td>
<td>Float:1.278409</td>
<td>Integer:10</td>
<td>ScreenPosition:&#x3C;600, 292></td>
</tr>
<tr>
<td>200</td>
<td>1092</td>
<td>2</td>
<td>Position:&#x3C;443.9366, 1997.808, 0></td>
<td>Float:0</td>
<td>Float:0</td>
<td>Float:1.278409</td>
<td>Integer:10</td>
<td>ScreenPosition:&#x3C;600, 292></td>
</tr>
<tr>
<td>201</td>
<td>1095</td>
<td>2</td>
<td>Integer:-1950611085</td>
<td>Boolean:False</td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>201</td>
<td>1092</td>
<td>2</td>
<td>Position:&#x3C;443.9366, 1997.808, 0></td>
<td>Float:0</td>
<td>Float:0</td>
<td>Float:1.278409</td>
<td>Integer:10</td>
<td>ScreenPosition:&#x3C;600, 292></td>
</tr>
<tr>
<td>202</td>
<td>1092</td>
<td>2</td>
<td>Position:&#x3C;443.9366, 1997.808, 0></td>
<td>Float:0</td>
<td>Float:0</td>
<td>Float:1.278409</td>
<td>Integer:10</td>
<td>ScreenPosition:&#x3C;600, 292></td>
</tr>
<tr>
<td>...</td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>214</td>
<td>1092</td>
<td>2</td>
<td>Position:&#x3C;443.9366, 1997.808, 0></td>
<td>Float:0</td>
<td>Float:0</td>
<td>Float:1.278409</td>
<td>Integer:10</td>
<td>ScreenPosition:&#x3C;600, 294></td>
</tr>
<tr>
<td>215</td>
<td>1092</td>
<td>2</td>
<td>Position:&#x3C;443.9366, 1997.808, 0></td>
<td>Float:0</td>
<td>Float:0</td>
<td>Float:1.278409</td>
<td>Integer:10</td>
<td>ScreenPosition:&#x3C;600, 294></td>
</tr>
<tr>
<td>216</td>
<td>1049</td>
<td>2</td>
<td>Integer:774</td>
<td>Position:&#x3C;553.6661, 1923.072, 140></td>
<td>Float:-0.7853982</td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>216</td>
<td>1092</td>
<td>2</td>
<td>Position:&#x3C;443.9366, 1997.808, 0></td>
<td>Float:0</td>
<td>Float:0</td>
<td>Float:1.278409</td>
<td>Integer:2</td>
<td>ScreenPosition:&#x3C;600, 294></td>
</tr>
<tr>
<td>217</td>
<td>1092</td>
<td>2</td>
<td>Position:&#x3C;443.9366, 1997.808, 0></td>
<td>Float:0</td>
<td>Float:0</td>
<td>Float:1.278409</td>
<td>Integer:13</td>
<td>ScreenPosition:&#x3C;600, 294></td>
</tr>
<tr>
<td>218</td>
<td>1092</td>
<td>2</td>
<td>Position:&#x3C;443.9366, 1997.808, 0></td>
<td>Float:0</td>
<td>Float:0</td>
<td>Float:1.278409</td>
<td>Integer:13</td>
<td>ScreenPosition:&#x3C;600, 294></td>
</tr>
<tr>
<td>...</td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>299</td>
<td>1092</td>
<td>2</td>
<td>Position:&#x3C;443.9366, 1997.808, 0></td>
<td>Float:0</td>
<td>Float:0</td>
<td>Float:1.278409</td>
<td>Integer:13</td>
<td>ScreenPosition:&#x3C;558, 297></td>
</tr>
<tr>
<td>300</td>
<td>1092</td>
<td>2</td>
<td>Position:&#x3C;443.9366, 1997.808, 0></td>
<td>Float:0</td>
<td>Float:0</td>
<td>Float:1.278409</td>
<td>Integer:13</td>
<td>ScreenPosition:&#x3C;543, 301></td>
</tr>
<tr>
<td>301</td>
<td>1095</td>
<td>2</td>
<td>Integer:752532121</td>
<td>Boolean:False</td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>301</td>
<td>1092</td>
<td>2</td>
<td>Position:&#x3C;443.9366, 1997.808, 0></td>
<td>Float:0</td>
<td>Float:0</td>
<td>Float:1.278409</td>
<td>Integer:13</td>
<td>ScreenPosition:&#x3C;528, 304></td>
</tr>
<tr>
<td>302</td>
<td>1092</td>
<td>2</td>
<td>Position:&#x3C;443.9366, 1997.808, 0></td>
<td>Float:0</td>
<td>Float:0</td>
<td>Float:1.278409</td>
<td>Integer:13</td>
<td>ScreenPosition:&#x3C;517, 306></td>
</tr>
<tr>
<td>...</td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>353</td>
<td>1092</td>
<td>2</td>
<td>Position:&#x3C;443.9366, 1997.808, 0></td>
<td>Float:0</td>
<td>Float:0</td>
<td>Float:1.278409</td>
<td>Integer:13</td>
<td>ScreenPosition:&#x3C;403, 215></td>
</tr>
<tr>
<td>354</td>
<td>1092</td>
<td>2</td>
<td>Position:&#x3C;443.9366, 1997.808, 0></td>
<td>Float:0</td>
<td>Float:0</td>
<td>Float:1.278409</td>
<td>Integer:13</td>
<td>ScreenPosition:&#x3C;403, 215></td>
</tr>
<tr>
<td>355</td>
<td>1003</td>
<td>2</td>
<td>Boolean:True</td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>355</td>
<td>1001</td>
<td>2</td>
<td>Boolean:True</td>
<td>ObjectId:468</td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>355</td>
<td>1092</td>
<td>2</td>
<td>Position:&#x3C;443.9366, 1997.808, 0></td>
<td>Float:0</td>
<td>Float:0</td>
<td>Float:1.278409</td>
<td>Integer:2</td>
<td>ScreenPosition:&#x3C;403, 215></td>
</tr>
<tr>
<td>356</td>
<td>1092</td>
<td>2</td>
<td>Position:&#x3C;443.9366, 1997.808, 0></td>
<td>Float:0</td>
<td>Float:0</td>
<td>Float:1.278409</td>
<td>Integer:13</td>
<td>ScreenPosition:&#x3C;403, 215></td>
</tr>
<tr>
<td>...</td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>399</td>
<td>1092</td>
<td>2</td>
<td>Position:&#x3C;443.9366, 1997.808, 0></td>
<td>Float:0</td>
<td>Float:0</td>
<td>Float:1.278409</td>
<td>Integer:2</td>
<td>ScreenPosition:&#x3C;265, 509></td>
</tr>
<tr>
<td>400</td>
<td>1092</td>
<td>2</td>
<td>Position:&#x3C;443.9366, 1997.808, 0></td>
<td>Float:0</td>
<td>Float:0</td>
<td>Float:1.278409</td>
<td>Integer:2</td>
<td>ScreenPosition:&#x3C;265, 511></td>
</tr>
<tr>
<td>401</td>
<td>1095</td>
<td>2</td>
<td>Integer:1629276425</td>
<td>Boolean:False</td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>401</td>
<td>1092</td>
<td>2</td>
<td>Position:&#x3C;443.9366, 1997.808, 0></td>
<td>Float:0</td>
<td>Float:0</td>
<td>Float:1.278409</td>
<td>Integer:2</td>
<td>ScreenPosition:&#x3C;265, 511></td>
</tr>
<tr>
<td>402</td>
<td>1092</td>
<td>2</td>
<td>Position:&#x3C;443.9366, 1997.808, 0></td>
<td>Float:0</td>
<td>Float:0</td>
<td>Float:1.278409</td>
<td>Integer:2</td>
<td>ScreenPosition:&#x3C;265, 511></td>
</tr>
<tr>
<td>...</td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>475</td>
<td>1092</td>
<td>2</td>
<td>Position:&#x3C;443.9366, 1997.808, 0></td>
<td>Float:0</td>
<td>Float:0</td>
<td>Float:1.278409</td>
<td>Integer:2</td>
<td>ScreenPosition:&#x3C;214, 493></td>
</tr>
<tr>
<td>475</td>
<td>1092</td>
<td>2</td>
<td>Position:&#x3C;443.9366, 1997.808, 0></td>
<td>Float:0</td>
<td>Float:0</td>
<td>Float:1.278409</td>
<td>Integer:2</td>
<td>ScreenPosition:&#x3C;214, 493></td>
</tr>
<tr>
<td>475</td>
<td>27</td>
<td>2</td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
</tbody>
</table>
</div>
<p>Let's try to figure out what each order type means:</p>
<ul>
<li><code class="language-text">1092</code>: It's not obvious in the trimmed version, but this order type appears the most times, <em>by far</em>. We see it has 6 arguments: a 3D position, 3 floats, 1 integer, and 1 2D position. If you load the map we used in World Builder (the Generals editing tool), you'll find that the 3D position in these orders corresponds with the map point at the centre of the screen. So it's very likely that <code class="language-text">1092</code> is some sort of <strong>set camera position</strong> order. It's weird that Generals saves one of these for each timecode, even when the camera hasn't moved; the replay file would be much smaller if it only saved this order when the camera moved. The non-zero float argument might be field-of-view, and I don't yet know what the other arguments mean.</li>
<li><code class="language-text">1095</code>: This appears exactly every 100 timecodes. It has 1 integer and 1 boolean argument. Based on what I know about how RTS games do lockstep networking, and seeing that the integer argument value varies wildly, I guess this is a <strong>checksum</strong> order, which instructs the game engine to check that its internal world representation is in sync with other network players. In this case, there are no network players, but for simplicity the game engine probably runs this code anyway. Incidentally, it's when this value doesn't match the game's computed state that you get the dreaded "game has detected a mismatch" error.</li>
<li><code class="language-text">1003</code>, immediately followed by <code class="language-text">1001</code>: This timecode corresponds to when I selected the dozer. So <code class="language-text">1003</code> is probably <strong>clear selection</strong>, and <code class="language-text">1001</code> is probably <strong>set selection</strong>. <code class="language-text">1001</code> has an <code class="language-text">ObjectId</code> argument, which would be the ID of the object that should be selected. <a href="https://github.com/qibbi">Jana Mohn</a> helped me figure out that this is a runtime ID, with the index based on all the objects that have been loaded for the current map. As with many other aspects of replay files, only if the engine loads exactly the same things in exactly the same order, will it be able to successfully play a replay and get the same result.</li>
<li><code class="language-text">1049</code>: This has 1 integer, 1 3D position, and 1 float argument. The timecode corresponds to when I told the dozer to build a power plant, so this is probably a <strong>build object</strong> order. The integer argument is some kind of ID representing the object to build - and with experimentation, I have discovered that it's an index into an array of all the <code class="language-text">Object</code> definitions after they've been loaded from .ini files. The 3D position argument is where to build it, and the float argument is the angle at which to place the building.</li>
<li><code class="language-text">27</code>: This is always the last order in a replay file, so it's some sort of <strong>end game</strong> order.</li>
</ul>
<p>And that's it, for this simple replay file. Only 6 unique order types. Obviously in a full game, there would be many more order types, but this blog post is long enough already.</p>
<h2>In action</h2>
<p>As I mentioned at the beginning, my motivation for parsing Generals replay files is being to play them in OpenSAGE. So, I implemented just enough in OpenSAGE to be able to parse and "play" this simple replay file, and here is the result. It's obviously extremely unfinished, but hopefully you can see the connection with the original replay. You can also see our work on the main menu, replay menu, map rendering, etc...</p>
<div class="video-responsive">
    <iframe width="560" height="315" src="https://www.youtube.com/embed/XNP_DfLrVQw" frameborder="0" gesture="media" allow="encrypted-media" allowfullscreen></iframe>
</div>
<p>The code for "playing" a replay iterates through the chunks, with the appropriate timing, and executes each chunk's order - for example, creating a building or setting the camera's position. There's a huge amount still to do. There are some mysteries that will have to be solved, such as the random number generator (RNG) used by Generals, so there are no guarantees that we'll really be able to do it - but if I worried too much about that, I wouldn't have started OpenSAGE in the first place. On the bright side, much of the code for running through a replay will carry over, as-is, to actually playing single-player and multi-player games.</p>
<h2>The end</h2>
<p>Hopefully that gives a rough picture of how one goes about parsing a binary file format where you know roughly what it should contain, but you don't know the exact structure. Again, many thanks to louisdx for the <a href="https://github.com/louisdx/cnc-replayreaders">cnc-replayreaders project</a>. If I wasn't able to build on that existing knowledge, this would have been a lot more difficult.</p>
<p>Parsing of Generals .rep replay files <a href="https://github.com/OpenSAGE/OpenSAGE/tree/master/src/OpenSage.Game/Data/Rep">is implemented in OpenSAGE here</a>. If you're interested, you can browse the full code to see details I left out in this blog post.</p>
<p>If you're interested in what we're doing in OpenSAGE, <a href="https://discord.gg/G2FhZUT">join our Discord server</a> and chat to us, we're quite friendly!</p></div></div><footer><div class="footer__content"><p>OpenSAGE is an open source project and not associated with Electronic Arts or any other company. All trademarks are property of their respective owners. Screenshots of copyrighted works are only used for demonstration purposes.</p><p> OpenSAGE <!-- -->2018</p></div></footer></div></div></div><script id="gatsby-script-loader">/*<![CDATA[*/window.page={"componentChunkName":"component---src-templates-post-js","jsonName":"blog-parsing-command-and-conquer-generals-replay-files-5f3","path":"/blog/parsing-command-and-conquer-generals-replay-files"};window.dataPath="602/path---blog-parsing-command-and-conquer-generals-replay-files-5-f-3-662-RlrRYWsbhCuTC90tZQ8xAClhz0";/*]]>*/</script><script id="gatsby-chunk-mapping">/*<![CDATA[*/window.___chunkMapping={"app":["/app.fc21a18936c09a7a9afc.css","/app-655b54fb054b7e85ea3d.js"],"component---src-templates-post-js":["/component---src-templates-post-js.25a428dd87ac91a6df15.css","/component---src-templates-post-js-40108c553aa84ce37c7c.js"],"component---src-pages-404-js":["/component---src-pages-404-js-6bf631c13274568c4f59.js"],"component---src-pages-blog-js":["/component---src-pages-blog-js.b3975683587ddf0d3f4d.css","/component---src-pages-blog-js-6fb1762cbbbd18a5c374.js"],"component---src-pages-index-js":["/component---src-pages-index-js.b3975683587ddf0d3f4d.css","/component---src-pages-index-js-de677d5cb6077486b54e.js"]};/*]]>*/</script><script src="/component---src-templates-post-js-40108c553aa84ce37c7c.js" async=""></script><script src="/1-99665077469193db6513.js" async=""></script><script src="/0-f45a33594b6668cdd6f8.js" async=""></script><script src="/app-655b54fb054b7e85ea3d.js" async=""></script><script src="/webpack-runtime-293e875d3292be04e83b.js" async=""></script></body></html>