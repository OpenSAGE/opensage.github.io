{
    "componentChunkName": "component---src-templates-post-js",
    "path": "/blog/roads-how-boring-part-11-rendering-end-caps",
    "result": {"data":{"markdownRemark":{"html":"<style type=\"text/css\">\nimg[src*=\".gif\"] {\n  margin-left: auto; \n  margin-right: auto; \n  max-width: 500px;\n  display: block;\n}\n</style>\n<p>Figuring out how to render the roads correctly in OpenSAGE turned out to be a little more challenging than expected. This is the eleventh post in a series describing the journey.</p>\n<p>In the <a href=\"/blog/roads-how-boring-part-10-considering-the-terrain\">last post</a> we took care of uneven terrain. All that's missing now are the end caps that can be added to straight road segments so that they \"fade out\" instead of ending abruptly.</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 600px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/2921240b642446c1280e1a014e986d20/1e088/end_caps.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 33.33333333333333%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAHCAIAAACHqfpvAAAACXBIWXMAAA7DAAAOwwHHb6hkAAABYElEQVQY01XIUU+CQAAAYH5MzTJJIaKGbZmlpsBxd9zBHR4HnCSSlpq11npp64+3Vj20fU+fRkk7Ih2COr57hNExCU1GrX8JdUostQrKelLOrsu8n4meyq9y2dMQOMfQILgdEYNFBo/tMgO/GX5nTNsJO3tYCqFAWvmyulWqP1O9QlxoiyKaF1jyIQInMGhJ0X1ayr8c4MCKqS1F9303393nm2Va3YVkk/AXkVdjrZjC9WK6qbOUX0Ogh9DkdPSTj5VYL6TkfYzMmaKrGXtZF4+vq/rzTT0kWPY1BLplRop04HmNm8EeRgbwdQScuzza1rLMJsPhPsYmqjxeBPV2cf/xXO5yEDsRsbXJuBF4uu83Ce5A0Iqp5bpNd3ygxGgaX9LQgKDFqIWZM96y4imbrjlXN0lki8TRfLf5zTskYZsgI6YGDHTfawKv5bqN34xMRk8pc1A5gllPMDtNLjg7/QKtTYXKu4Lo6AAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"A road with and without end caps and in wireframe mode\"\n        title=\"A road with and without end caps and in wireframe mode\"\n        src=\"/static/2921240b642446c1280e1a014e986d20/0a47e/end_caps.png\"\n        srcset=\"/static/2921240b642446c1280e1a014e986d20/8a4e8/end_caps.png 150w,\n/static/2921240b642446c1280e1a014e986d20/5a46d/end_caps.png 300w,\n/static/2921240b642446c1280e1a014e986d20/0a47e/end_caps.png 600w,\n/static/2921240b642446c1280e1a014e986d20/1e088/end_caps.png 840w\"\n        sizes=\"(max-width: 600px) 100vw, 600px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span></p>\n<p>At first glance, that doesn't look too difficult, we just need to figure out the world and texture coordinates. We know how to do that by now, and that alone would hardly warrant an extra post.</p>\n<h2>Joining different roads</h2>\n<p>However, the checkbox says \"Add end caps <em>and/or Join to different road</em>\" and this is where things get interesting: When a road with an end cap ends near another road (of a different type), the end cap is rotated so that it forms a 90° angle with that other road. The straight road segment it belongs to is modified accordingly (just like for <a href=\"/blog/roads-how-boring-part-5-connecting-the-road-segments\">angled connections</a>).</p>\n<p><img src=\"/0b6cc4a85d32ca3c6379750d3748054b/join.gif\" alt=\"A road with an end cap joining another road\"></p>\n<p>As you can see in the animation, this can lead to strange visual artefacts when the angle between the two roads becomes too small.</p>\n<h3>Finding joinable roads</h3>\n<p>First, we need to find out if there is any road segment our end cap can join. We do that by looking at all straight road segments (joining curves or crossings does not work in the original engine).</p>\n<p>Let's start with a road segment, an end cap position and a direction of the end cap's segment. When the position is near enough, the end cap rectangle (green) is rotated to match the road segment and we need to calculate the angle <code>α</code>.</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 600px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/0115a47de3c252de3346eba1ebf7ad45/fbf08/end_caps_drawing_1.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 82%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAQCAIAAACZeshMAAAACXBIWXMAAA7DAAAOwwHHb6hkAAABDElEQVQoz5XTXW+DIBQGYP//D1yydBdNTZtqh5wDh/INi7CwdkWznQtjiI/vG8Eh9ybltF7qfZnuY0Pf5h8oy3R9B8cY4T7riFWKMl0/WGudc957IpIkc85k+Fm9MXu84UUKqsmISETee2NMCOEbp5R8GWOMvhulxcjer3A8XQ+f7La+Ua6xRAQA8zxrrWOMndoh2cWeFjtelg9ATqSqbOWFEEqp1v8Jx+y5Hc/8AAgts0pEfOxf/RNOKQuJgEuR8lW2FSnlb+y9BwBJckfWcK11Z6ucc4iwIwGgyv4+F4+t3pbcOmHZWjtNE2OMc74lN3H1jLFW+1Xu4cf+7Qv9A1ffzfwTXo9dCFu/5BcgKqdPm5EHQQAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"Road segment and rotated end cap\"\n        title=\"Road segment and rotated end cap\"\n        src=\"/static/0115a47de3c252de3346eba1ebf7ad45/0a47e/end_caps_drawing_1.png\"\n        srcset=\"/static/0115a47de3c252de3346eba1ebf7ad45/8a4e8/end_caps_drawing_1.png 150w,\n/static/0115a47de3c252de3346eba1ebf7ad45/5a46d/end_caps_drawing_1.png 300w,\n/static/0115a47de3c252de3346eba1ebf7ad45/0a47e/end_caps_drawing_1.png 600w,\n/static/0115a47de3c252de3346eba1ebf7ad45/1cfc2/end_caps_drawing_1.png 900w,\n/static/0115a47de3c252de3346eba1ebf7ad45/fbf08/end_caps_drawing_1.png 962w\"\n        sizes=\"(max-width: 600px) 100vw, 600px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span></p>\n<p>We have to check if the position of the end cap node is within the road segment (plus a little margin).</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 600px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/f22010639866a9ad302d3f739f17bcf4/fbf08/end_caps_drawing_2.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 82%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAQCAIAAACZeshMAAAACXBIWXMAAA7DAAAOwwHHb6hkAAABQUlEQVQoz43SUXOCMAwAYP7/39udQItDnTI3RWhTaIE22QqinpbdQh94yNemaSIKBfoP/d+FsEC0GEyLwnaKC+EWVaravCX7P+ycq823PksvMwUMIIF2E/BR13V93w/DoJQCACJSXVXskzLbnfmnYo3iym8Rg95o21vTGWuv20SIOIxhjNGNaTq5z9lXut2lWZmcG94oDpOXsSyT0rTGORco21JXHQ9VVhRsLVjd8PYquS9eMgkJmK0hF7qzK4dqffAyFfczJ5nKe/25nu7/gHvCnGQmBKtGqZ7ltEbv++9ueHwdCxZWcM97leMSTGiu6fh48s3HoNiyTIUv+4NIP73z7FV87dAfMjQkox/kcHo7lawUXCxJwuB4zr5e1ZLLJbk023P90tev2NihF7mMHzysQL8H5J94znPgcIev8hf/AP99m3XbzN3uAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"Target area in which an end cap joins the segment\"\n        title=\"Target area in which an end cap joins the segment\"\n        src=\"/static/f22010639866a9ad302d3f739f17bcf4/0a47e/end_caps_drawing_2.png\"\n        srcset=\"/static/f22010639866a9ad302d3f739f17bcf4/8a4e8/end_caps_drawing_2.png 150w,\n/static/f22010639866a9ad302d3f739f17bcf4/5a46d/end_caps_drawing_2.png 300w,\n/static/f22010639866a9ad302d3f739f17bcf4/0a47e/end_caps_drawing_2.png 600w,\n/static/f22010639866a9ad302d3f739f17bcf4/1cfc2/end_caps_drawing_2.png 900w,\n/static/f22010639866a9ad302d3f739f17bcf4/fbf08/end_caps_drawing_2.png 962w\"\n        sizes=\"(max-width: 600px) 100vw, 600px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span></p>\n<p>We know the segment direction. It's normal vector is the direction to the corner. The length to the corner is half a road width (<code>RoadWidth * RoadWidthInTexture / 2</code>). The additional length of the margin appears to be <code>RoadWidth / 10</code>.</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 600px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/1d0e00c10f7890911de6b22c6dae3d8d/fbf08/end_caps_drawing_3.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 82%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAQCAIAAACZeshMAAAACXBIWXMAAA7DAAAOwwHHb6hkAAABa0lEQVQoz43SyXLbMAwAUP//r+XQTqa1JNKxE3mrGykSAXCRuaCV5Ka1zWSK4fDERwIgFpyLxGncmFlx2qYUUvbYIm/ngFFSRaY2HP8Pxxh7+9P2MMoVoUAsMesXwzCcz2fvPREhIjPT0B2ORbuuG3kkoUnSeEWJdmtDCM65EMIFp5T8FM45q50eYFeLk3ypy1VbNlpqkjh7KKCVrbMuhphJO/DQNbtuvT+IJyV6Lc1FyjF5EIAlup1778kVjuC75/2+elJC/X1zlhVc8i/Q1nb2/2DPXLJ5RP0VtDB4L+c11W9exv5dvWx1PG3M68bAirTAjJyWEspKy4e7ryIfN8+2KfWbsH0BUAGu9JWslN1YPjK7GzxVYiCelvbtm8KHrfn+aoqGBN7KITckafIWfPNl3y2PavlDF+2Mb2R+wmZ/Jt8LgLFDJis/mu1L/oECVUgClYB7+TF+9zqMg7nOyE/xHx8hpjrdy9/4F+JBmz2f+CT3AAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"Calculating the corners of the target area\"\n        title=\"Calculating the corners of the target area\"\n        src=\"/static/1d0e00c10f7890911de6b22c6dae3d8d/0a47e/end_caps_drawing_3.png\"\n        srcset=\"/static/1d0e00c10f7890911de6b22c6dae3d8d/8a4e8/end_caps_drawing_3.png 150w,\n/static/1d0e00c10f7890911de6b22c6dae3d8d/5a46d/end_caps_drawing_3.png 300w,\n/static/1d0e00c10f7890911de6b22c6dae3d8d/0a47e/end_caps_drawing_3.png 600w,\n/static/1d0e00c10f7890911de6b22c6dae3d8d/1cfc2/end_caps_drawing_3.png 900w,\n/static/1d0e00c10f7890911de6b22c6dae3d8d/fbf08/end_caps_drawing_3.png 962w\"\n        sizes=\"(max-width: 600px) 100vw, 600px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span></p>\n<p>Once we know the corner positions of that rectangle, a quick way to eliminate most of the join candidates is by checking if the end cap position is within the axis-aligned bounding box.</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 600px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/cdbaa2cb59494cc6cb80fda2d2b536cf/fbf08/end_caps_drawing_4.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 82%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAQCAYAAAAWGF8bAAAACXBIWXMAAA7DAAAOwwHHb6hkAAAB9klEQVQ4y3WUiY7aMBRF8/+/VlWq2jKQZchMyMKwJ45jCMGnso2BMNTRkx3bOrp+W4AZGjcU6FJDBbrSI6MEnWh3vnTn/p6ZrX1BoLXGmvmkRucaXWgosBA7F9g9EQpEJNx56fa82TulJuBxqCukhEt+YZ9+oYraXhaxoIkaa2btod7sfwXB6XSi73vOwxmxFYi5sAfi40CRTthkKeuoRIQtbSxo45YmbGiTlnN+5rg4MuSDgxqF5rkG2A896qDo5or2oyGbzajmKZ+ziE24RsbSPteYgdazmtVkhcoUQzH8/8lD3rPNMnZZRhEm1OHhG8zMRqXxqUzk3adeoQ8KHQxFz26xII/iJ1g7hkX35998anzo08YiWw0TkL8F8leNjKS9/E3Zw7+FRk4t+RPQKOzSgWUsWacdTSKQJhCJh9UjmLgGqQ5rVKLgfQQE3TlfiOrCfN6xCSW7UHGYNk5ZIl/DUnVL8uBeKU6hSWxz2L0PLP907P7WiB8Z3WSFnG5oLaz9Div0Q5S9Dzt9qwpTXmp+ZvVzwf6top5UyDcH9Gkzgl0jHTzWsgPqUeYfsxPbcE9jVF2f/ErZOA99c+gYlZRf95+9hZhKeQl7LL1noAn9qOA9NOs5TA8OVr64c20mwXP7suqe2pJvWUM6QIprX+VT+yrd/j9nSsw2NW5SmwAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"Axis-aligned bounding box\"\n        title=\"Axis-aligned bounding box\"\n        src=\"/static/cdbaa2cb59494cc6cb80fda2d2b536cf/0a47e/end_caps_drawing_4.png\"\n        srcset=\"/static/cdbaa2cb59494cc6cb80fda2d2b536cf/8a4e8/end_caps_drawing_4.png 150w,\n/static/cdbaa2cb59494cc6cb80fda2d2b536cf/5a46d/end_caps_drawing_4.png 300w,\n/static/cdbaa2cb59494cc6cb80fda2d2b536cf/0a47e/end_caps_drawing_4.png 600w,\n/static/cdbaa2cb59494cc6cb80fda2d2b536cf/1cfc2/end_caps_drawing_4.png 900w,\n/static/cdbaa2cb59494cc6cb80fda2d2b536cf/fbf08/end_caps_drawing_4.png 962w\"\n        sizes=\"(max-width: 600px) 100vw, 600px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span></p>\n<p>If it is, we need to check if it actually is within the rectangle. We calculate the vector <code>StartToPosition</code> from the segment start position to the end cap position. The cross product of this vector and the <code>SegmentDirection</code> gives us the normal distance of the end cap position. Using the dot product, we can project <code>StartToPosition</code> onto <code>SegmentDirection</code> to get the <code>SignedDistanceFromStart</code>.</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 600px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/867f09cea3285a90215e9050b87a034f/fbf08/end_caps_drawing_5.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 82%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAQCAIAAACZeshMAAAACXBIWXMAAA7BAAAOwQG4kWvtAAABVUlEQVQoz5XT226jMBQF0Pz/B/ahGrVJJkMSLva5YoNtTgVETdohlbofEA8se3MMO9vKZNN8We+XbD6227Z2h7xk02/gUgpoHQqukpZs+t0wDOM4ppREhIXNTKKv9KUb9g1WTLLujIgiklKKMeacb3iaprQkxhj6qJH219ez2x+vr23XzCvyvK2IAEBd1yGEUspG7VwGNx4bPR0vbwBeRGmRn+WJSFU/+3/BxZIf/p7cn65FJnGNuLoHNy+BiI/9V/+AsxkbKXjvwSkzITAh3+Stwa0FM/9XW7O+9/2/3l2lu/a+68ETIrCQyB0jYghh46iyZGkZHBMLAXSteB/QKzihpTgArPLJOWvBi2Dr5XDgqsHKoZP5zUkQ7/LZF2ZJ0uXt5M4Vns/aNcwkyt/kU2xmwzh03s9NRZe2+E3+hM1sHEcEeJzQL/DqHyf0OzzPP+dnv+QH9DumBOigeNgAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"Checking if the end cap position is in the target area\"\n        title=\"Checking if the end cap position is in the target area\"\n        src=\"/static/867f09cea3285a90215e9050b87a034f/0a47e/end_caps_drawing_5.png\"\n        srcset=\"/static/867f09cea3285a90215e9050b87a034f/8a4e8/end_caps_drawing_5.png 150w,\n/static/867f09cea3285a90215e9050b87a034f/5a46d/end_caps_drawing_5.png 300w,\n/static/867f09cea3285a90215e9050b87a034f/0a47e/end_caps_drawing_5.png 600w,\n/static/867f09cea3285a90215e9050b87a034f/1cfc2/end_caps_drawing_5.png 900w,\n/static/867f09cea3285a90215e9050b87a034f/fbf08/end_caps_drawing_5.png 962w\"\n        sizes=\"(max-width: 600px) 100vw, 600px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span></p>\n<p>If the normal distance is less than <code>TotalLength</code> and <code>SignedDistanceFromStart</code> is between <code>0</code> and <code>SegmentLength</code>, then the end cap position is within the rectangle and we can calculate the angle <code>α</code> using trigonometric functions.</p>\n<h3>Calculating the coordinates</h3>\n<p>The end cap quad's length is <code>0.375 * RoadWidth</code>, although it partially overlaps the road segment it belongs to (by <code>0.13 * RoadWidth</code>).\nThe default end cap width is <code>1.064 * RoadWidth</code>. Probably <code>RoadWidthInTexture</code> should also be considered here, but it isn't in the original engine.</p>\n<p>However, as you can see in the animation above, when an end cap joins another road, it gets wider depending on the angle. We can calculate the actual width by dividing the default width by the cosine of the angle we calculated before.</p>\n<p>The texture coordinates are just some more magic numbers:</p>\n<table>\n<thead>\n<tr>\n<th>Left</th>\n<th>Top</th>\n<th>Right</th>\n<th>Bottom</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td><code>0.146</code></td>\n<td><code>0.697</code></td>\n<td><code>0.238</code></td>\n<td><code>0.961</code></td>\n</tr>\n</tbody>\n</table>\n<p>And now we can render the end caps:</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 600px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/19c578a82abbc862ebc5b4251314d786/eb3fa/open_sage_end_caps.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 77.99999999999999%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAQCAIAAACZeshMAAAACXBIWXMAAA7DAAAOwwHHb6hkAAADjElEQVQozwXBaU/bZgAAYP+HadqHaZf2YR+GNAG5ncsJCcEkwY4d347z+nbixI4dCCHlCBVlZQzagqhou6orUreJjnZTJwbhKKvo79rzQKPR68ur1+9v3pyNjv85/ePf8+PRxcn5xcnF1cn1zdvb23fXN+8/3J5+/Pjuvw9/X1y9Ob88ubx+ezb68/TsGAJKjBPDeHUCI8cpNkBxQYoLVqgJip0ESkQzmYYtdLy03U7V5ChJTzJCuCZHGT7ICEHIshDdRFQtbbemWk623cl1ugW/m2/aiGwwdU3RjIyiJyUQN62s4073euh8D/X8vOvloYadkdWEoiWtJmJYGc1AgJJU9QQrlssUTwsIK4RpLopXQ3N4gOYiip4EaoqvwUBNQYwQZQUYIwMEFWEFmGIjZTwwXUTKVZGXZlk+qJuIoiVZEa5QQUaIciJM0mG8Gq4yEajKRRgOxskQRoRYIcpLUUYsYZTICMxMcZykwqqWUDVYqkeBCksKLMkJSY5rRhIoMKToCC/Gqmy0hAVmyz9U6AIrKZs/Dh8+uGtZBEEHagA2DERVk7qeklW42cw4bbRto56LQ0BNKVq6rqQYIUKLaJnim65z+Pj+q6P9Z4dbywPZNJBmI99plRd8emUJrC0Zw0FzdbGx5GsQTk0CLeF6U6ZNAMPk6mpNIVgR6S22d3fu7T643523bJtd8KXBorYyMFf6+vKiOu9SHWcOAkrWsNKskCe4Gs5KtFAtVwK56TF0NqQZ8urqnbW7qyvD/tqy6Tqlpo12vaLrZnUrYdlpSDcQSZmdmatgFE+LHCsk8uhYIvNdrjCGEQnHbWxsrj8+/PnJwb2uh6ta2LLjjpMGRoxXopAkz6IYgTGcbFiOTwAtVqECpcokToYYMdJ2qF6/u7k9/OVw8+H26nBZn/cLCwszfjfr+gWoWCFKBEWwNaCTupUFRoYDyZqMyGqu2c45HdTxxJ+2158cbLx4uvXy6cHWRtfroIv9Yrebh1CMLBN0lcN4MU7xcZKPSWpS1WOmGW+1kVY74Xk5v0Pubq8dPX/024u9v35/ub+zPuhRS30UIkWZlk1Wrkug0mwVJDkugFDbzZmNGctCDStrt5FGIzLoc3s7G8evnv169PzR/t7K8I7tMtCnX3z52TfffvL51199Py61VNmoCHKJljgUrxbmiBmM4GVeNXBglL2lBaXlT1H1VIlIFomJeOp/ZNt1yxh3cjMAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"Rendered end caps\"\n        title=\"Rendered end caps\"\n        src=\"/static/19c578a82abbc862ebc5b4251314d786/0a47e/open_sage_end_caps.png\"\n        srcset=\"/static/19c578a82abbc862ebc5b4251314d786/8a4e8/open_sage_end_caps.png 150w,\n/static/19c578a82abbc862ebc5b4251314d786/5a46d/open_sage_end_caps.png 300w,\n/static/19c578a82abbc862ebc5b4251314d786/0a47e/open_sage_end_caps.png 600w,\n/static/19c578a82abbc862ebc5b4251314d786/1cfc2/open_sage_end_caps.png 900w,\n/static/19c578a82abbc862ebc5b4251314d786/eb3fa/open_sage_end_caps.png 1026w\"\n        sizes=\"(max-width: 600px) 100vw, 600px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span></p>\n<h3>Modifying the Z-order</h3>\n<p>One more thing we can see in the animation above is that the join affects the drawing order of the roads: By default, the light road is drawn below the dark one. But once the end cap becomes a join, it is drawn above (so that the end cap becomes visible).</p>\n<p>Let <code>A</code>, <code>B</code> and <code>C</code> be different roads with this default order: <code>A, B, C</code>.</p>\n<p>Whenever a join is encountered while reading a map file, the joining road is moved to the back of the list so that it is rendered last. There is only one global order, so <em>all</em> roads of the joining road's type are now rendered above <em>all</em> others (until the next join is encountered).</p>\n<p>When we add a join from <code>A</code> to <code>C</code>, <code>A</code> is moved to the back (<code>B, C, A</code>) and we store the information, that <code>A > C</code>.</p>\n<p>Let's add another join from <code>B</code> to <code>A</code>. The order becomes <code>C, A, B</code> and the dependencies are <code>A > C, B > A</code>.</p>\n<p>Now let's add a join from <code>C</code> to <code>A</code>. <code>C</code> is moved to the back: <code>A, B, C</code>. However, we know that <code>A</code> has to come after <code>C</code>, so we move <code>A</code> with <code>C</code> and the order becomes <code>B, C, A</code>. But we also know that <code>B</code> has to come after <code>A</code>, so we have to move it to, and we end up with the order <code>C, A, B</code>.</p>\n<p>Of course, there can be cycles (e.g. <code>A > C, C > A</code>). As there is only one global order, it is impossible to draw all end caps above the joined roads in such situations.</p>\n<p>When it's written down like this, the algorithm doesn't look too complicated, but figuring out how it works just by examining different road joins proved to be quite difficult, as the outcome depends on the creation order of the roads. And while it may seem like an insignificant detail to get right, <em>not</em> getting it right could have quite an impact on the visuals:</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 600px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/cfe68ffeca2f6f41de4589ae11311feb/eb3fa/road_order.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 77.99999999999999%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAQCAIAAACZeshMAAAACXBIWXMAAA7CAAAOwgEVKEqAAAADfElEQVQozwXB207bZgAAYD/BNmnbxaQNLipVq6bRio4AORFIQhI7seP4+Nu/nd/nUxwncZwDSYAURtubXvUJJk1jFwyNtipdoaBN015r34ddfzy//vD71btf31+fX705//PtL++uf7u5vbz/++r27uLT3eXd/eX9Pxf//vfm9u7y+sPbm0/vb+8u/rr548PHC0zRnsjqOpDSTfopz6U54XuSecCDDdMoNJgfo2B/0CvCdganKrxEinJR1TI8WOWlR7qdwdxAjWNxGguDkOp3CaRvUcxDFqQMM6uaOaTjdKu6WyhTdN12cd3K6kZOhhmGS6naDia3KVGFkioYdrUTVKCaKVZWieYGC8p7u5n19Y1qrYKMMnLScjstqk8AfGyYJYbLE/UCxorrQM4zYr3BCCzgSTorSFtNLr+ZyqU3M43mHjJ3kL2lu1nZ3GgpDwFaMzrbSM8AkMWIZgqAHQlui7DIAZ4kGYohmgxONnGvizverm7neCWleXnJSnH8Fi9tIjvXVkqOiWNVIlUjfqKZTUHaBFIeqrKgIFZUgcIFUT1OKsmoZjtVoOSBnhHhlop2dVRLIniQ2JhrF6GSlmCOFQlBBhKqQ5TTbZaV21WSIxkcqvuOhdNMVjMrgz4zGxvzsT4bo8FAwWA7C2CNEXgBCoaFK+3sfn2t61OOX2cBVarRZYIEcsMw+G5PP14GhwfW8YGyGPG9DomRNAmgJMGibqZ9B5eUXKnxg+cQw37LdosyqgehNR2785l/tIxfxsrJlJzNyZNDbjahMapVR3qhin9Rxb+yjFIblTiw7Ttk5AuB23I9aTrxjufeYmr1hr2zWuV043EiFXuDUhQVMUFMa9pOi/9ur/yZZeyEHh1HwnQAjyZoOfeGsT8eBaNROJ6oQVeww86Al3pADfpGkjQxFRVse9+xS55bmg7BqzP3dGGOY/Biab48CZ4dhdOJH3aNTo/tJ+XRmA2GHLRammVploG57v5kRB0fSstF+3AKXr+wXv9sPz/SX506RwfGYmqcHHcOZ34YtXRvL5mUHTetG2k3ZEzXxpADnZ4V9H3P5cNOYRgSi0ToRZxltaJI63bVs5Pw+bPodKn34/J43vRj4Ha5cKRYoY59+e3q1ysPPv9mZeXRGuromsUpbYaDUpViajRTpVqabfX73iAJOiNXsq0SjwoNNltrPs1l/wdO4GpbJdLEkwAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"Getting the road order wrong\"\n        title=\"Getting the road order wrong\"\n        src=\"/static/cfe68ffeca2f6f41de4589ae11311feb/0a47e/road_order.png\"\n        srcset=\"/static/cfe68ffeca2f6f41de4589ae11311feb/8a4e8/road_order.png 150w,\n/static/cfe68ffeca2f6f41de4589ae11311feb/5a46d/road_order.png 300w,\n/static/cfe68ffeca2f6f41de4589ae11311feb/0a47e/road_order.png 600w,\n/static/cfe68ffeca2f6f41de4589ae11311feb/1cfc2/road_order.png 900w,\n/static/cfe68ffeca2f6f41de4589ae11311feb/eb3fa/road_order.png 1026w\"\n        sizes=\"(max-width: 600px) 100vw, 600px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span></p>\n<p>And...that's it, we're done! All that's left now is <a href=\"/blog/roads-how-boring-part-12-summing-up\">summing-up</a>.</p>","frontmatter":{"slug":"roads-how-boring-part-11-rendering-end-caps","title":"Roads? How boring! Part 11: Rendering end caps","summary":"Part 11 of the series about rendering the roads in SAGE maps: Rendering end caps","author":"Daniel Sklenitzka","date":"2020-07-31"}}},"pageContext":{"slug":"roads-how-boring-part-11-rendering-end-caps"}},
    "staticQueryHashes": []}